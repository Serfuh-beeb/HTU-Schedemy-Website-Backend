---
- name: Configure and Deploy Schedemy (Java Backend)
  hosts: role_SchedemyWebServer
  become: yes
  vars:
    git_safe_directory: /opt/schedemy
    # DB connection info â€” pass these with --extra-vars or from Terraform outputs
    db_host: "{{ lookup('env', 'DB_HOST') | default('localhost', true) }}"
    db_name: "{{ lookup('env', 'DB_NAME') | default('schedemy', true) }}"
    db_username: "{{ lookup('env', 'DB_USERNAME') | default('admin', true) }}"
    db_password: "{{ lookup('env', 'DB_PASSWORD') | default('changeme', true) }}"

  tasks:
    # --- 1. Install Real Dependencies (Java & Maven) ---
    - name: Update Cache and Install Java, Maven, Docker
      apt:
        name: 
          - 'openjdk-17-jdk'    # The Java Development Kit
          - 'maven'             # To build your pom.xml
          - 'docker.io'
          - 'git'
          - 'acl'
        state: present
        update_cache: yes

    # --- 2. Setup Project Directory ---
    - name: Create App Directory
      file:
        path: /opt/schedemy
        state: directory
        mode: '0777'  # Open permissions so we can copy files easily
        owner: ubuntu
        group: ubuntu

    # --- 3. Copy Your Code to the Server ---
    # Ansible will copy the code from GitHub Action runner -> EC2
    - name: Copy Project Files
      synchronize:
        src: ../
        dest: /opt/schedemy/
        rsync_opts:
          - "--exclude=.git"
          - "--exclude=target"
          - "--exclude=terraform"

    # --- 4. Stop placeholder Nginx container (if running) ---
    - name: Stop placeholder Nginx container
      shell: docker stop $(docker ps -q) || true
      ignore_errors: yes

    # --- 5. Build the JAR File ---
    - name: Build Application with Maven
      command: mvn clean package -DskipTests
      args:
        chdir: /opt/schedemy
      register: maven_build

    # --- 6. Run as a System Service (So it stays alive) ---
    - name: Create Systemd Service for Schedemy
      copy:
        dest: /etc/systemd/system/schedemy.service
        content: |
          [Unit]
          Description=Schedemy Backend API
          After=network.target

          [Service]
          User=root
          WorkingDirectory=/opt/schedemy
          Environment="SPRING_PROFILES_ACTIVE=prod"
          Environment="DB_HOST={{ db_host }}"
          Environment="DB_NAME={{ db_name }}"
          Environment="DB_USERNAME={{ db_username }}"
          Environment="DB_PASSWORD={{ db_password }}"
          ExecStart=/usr/bin/java -jar /opt/schedemy/target/EduSched-0.0.1-SNAPSHOT.jar
          SuccessExitStatus=143
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    - name: Reload Systemd and Start App
      systemd:
        name: schedemy
        state: restarted
        enabled: yes
        daemon_reload: yes